# HEIC Image Converter 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

HEIC Image Converter

### 1.2 目的

HEIC（High Efficiency Image Container）形式の画像ファイルをJPEG形式に変換するためのコマンドラインツールを提供する。特に、iOSデバイスで撮影されたHEIC画像を、より広く互換性のあるJPEG形式に変換するニーズに対応する。

### 1.3 背景

- iOSデバイス（iPhone、iPad）で撮影された画像は、デフォルトでHEIC形式で保存される
- HEIC形式は多くのデスクトップアプリケーションやWebサービスで直接サポートされていない
- ユーザーはHEIC画像をJPEG形式に変換する必要がある
- 既存の変換ツールは複雑であったり、GUIが必要であったり、有料であったりする場合がある
- シンプルで使いやすいコマンドラインツールの需要がある

### 1.4 対象ユーザー

- 開発者
- システム管理者
- 画像処理を自動化したいユーザー
- コマンドライン操作に慣れているユーザー

## 2. 機能要件

### 2.1 必須機能（Must Have）

#### REQ-001: HEICからJPEGへの変換

- **優先度**: 最高
- **説明**: HEIC形式の画像ファイルをJPEG形式に変換する
- **詳細**:
  - 入力形式: HEIC (.heic)
  - 出力形式: JPEG (.jpg)
  - 出力品質: 高品質（JPEG品質95以上を推奨）
  - 出力先: 入力ファイルと同じディレクトリ
  - 出力ファイル名: 入力ファイル名の拡張子を`.jpg`に変更

#### REQ-002: 単一ファイル変換

- **優先度**: 最高
- **説明**: コマンドライン引数で指定された単一のHEICファイルを変換する
- **詳細**:
  - コマンド形式: `heic-convert input.HEIC`
  - ファイルパスは絶対パスまたは相対パスで指定可能
  - ファイルが存在しない場合はエラーメッセージを表示

#### REQ-003: ディレクトリ一括変換

- **優先度**: 高
- **説明**: 指定されたディレクトリ内の全HEICファイルを再帰的に検索して一括変換する
- **詳細**:
  - コマンド形式: `heic-convert /path/to/directory`
  - サブディレクトリも含めて検索
  - 変換結果のサマリーを表示（変換成功数、失敗数など）

#### REQ-004: カレントディレクトリ処理

- **優先度**: 高
- **説明**: 引数なしで実行した場合、カレントディレクトリ内の全HEICファイルを変換する
- **詳細**:
  - コマンド形式: `heic-convert`
  - カレントディレクトリを再帰的に検索
  - 変換結果のサマリーを表示

#### REQ-005: EXIF情報の保持

- **優先度**: 高
- **説明**: デフォルトでは、元のHEICファイルに含まれるEXIF情報を可能な限り保持する
- **詳細**:
  - 撮影日時、カメラ情報、GPS情報などのメタデータを保持
  - EXIF情報が存在しない場合は、EXIFなしでJPEGを生成

#### REQ-006: EXIF情報の削除オプション

- **優先度**: 中
- **説明**: `--remove-exif`オプションでEXIF情報を削除して変換する
- **詳細**:
  - プライバシー保護の用途に対応
  - コマンド形式: `heic-convert --remove-exif input.HEIC`
  - EXIF情報を完全に削除したJPEGファイルを生成

#### REQ-007: EXIF情報の表示オプション

- **優先度**: 中
- **説明**: `--show-exif`オプションでEXIF情報を表示する
- **詳細**:
  - 変換前にEXIF情報を標準出力に表示
  - 主要なEXIFタグ（撮影日時、カメラ情報、GPS情報など）を表示
  - コマンド形式: `heic-convert --show-exif input.HEIC`

#### REQ-008: EXIF情報のチェック機能

- **優先度**: 中
- **説明**: `--check-exif`オプションでJPEGファイルのEXIF情報の有無をチェックする
- **詳細**:
  - コマンド形式: `heic-convert --check-exif [ファイル/ディレクトリ]`
  - EXIF情報が残っている場合は警告を表示
  - チェック結果のサマリーを表示
  - 単一ファイル、ディレクトリ、カレントディレクトリに対応

### 2.2 推奨機能（Should Have）

#### REQ-009: エラーハンドリング

- **優先度**: 高
- **説明**: 適切なエラーメッセージを表示し、エラーが発生しても可能な限り処理を継続する
- **詳細**:
  - ファイルが見つからない場合のエラーメッセージ
  - HEICファイルのデコード失敗時のエラーメッセージ
  - JPEGファイルのエンコード失敗時のエラーメッセージ
  - EXIF情報の処理失敗時の警告メッセージ

#### REQ-010: 色空間変換

- **優先度**: 高
- **説明**: 様々な色空間（RGBA、NRGBA、YCbCrなど）のHEIC画像を適切にJPEGに変換する
- **詳細**:
  - アルファチャンネルがある場合は白背景に合成
  - 最適化された色空間変換処理を実装

### 2.3 将来の機能（Could Have）

#### REQ-011: 品質設定オプション

- **優先度**: 低
- **説明**: JPEG品質をユーザーが指定できるオプション
- **詳細**:
  - コマンド形式: `heic-convert --quality 85 input.HEIC`
  - デフォルトは95（高品質）

#### REQ-012: 出力ディレクトリ指定

- **優先度**: 低
- **説明**: 出力先ディレクトリを指定できるオプション
- **詳細**:
  - コマンド形式: `heic-convert --output-dir /path/to/output input.HEIC`

#### REQ-013: 元ファイル削除オプション

- **優先度**: 低
- **説明**: 変換成功後に元のHEICファイルを削除するオプション
- **詳細**:
  - コマンド形式: `heic-convert --delete-original input.HEIC`
  - デフォルトでは元ファイルを保持

#### REQ-014: 並列処理

- **優先度**: 低
- **説明**: 複数ファイルの変換を並列処理して高速化
- **詳細**:
  - コマンド形式: `heic-convert --parallel 4 /path/to/directory`
  - デデフォルトは順次処理

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### REQ-015: 処理速度

- **優先度**: 中
- **説明**: 一般的なサイズのHEIC画像（数MB程度）を数秒以内に変換できること
- **詳細**:
  - 画像サイズと複雑さに依存するが、実用的な速度を維持
  - 最適化された色空間変換処理により、処理速度を向上

#### REQ-016: メモリ使用量

- **優先度**: 中
- **説明**: メモリ使用量を適切に管理する
- **詳細**:
  - 画像全体をメモリに読み込む必要があるため、大きな画像ファイルの場合はメモリ使用量が増加することを許容
  - メモリリークを防止

### 3.2 互換性要件

#### REQ-017: プラットフォーム対応

- **優先度**: 最高
- **説明**: 主要なオペレーティングシステムで動作すること
- **詳細**:
  - Windows (amd64)
  - macOS (arm64) - Apple Siliconのみサポート（Intel版は非サポート）
  - Linux (amd64/arm64)

#### REQ-018: Goバージョン

- **優先度**: 高
- **説明**: Go 1.23以上でビルド・実行可能であること

### 3.3 使いやすさ要件

#### REQ-019: コマンドラインインターフェース

- **優先度**: 高
- **説明**: シンプルで直感的なコマンドラインインターフェースを提供する
- **詳細**:
  - 引数なしで実行した場合のヘルプ表示
  - オプションの説明を表示
  - エラーメッセージは分かりやすく日本語で表示

#### REQ-020: エラーメッセージ

- **優先度**: 高
- **説明**: 分かりやすいエラーメッセージを表示する
- **詳細**:
  - 日本語でのエラーメッセージ
  - エラーの原因を特定しやすいメッセージ
  - 解決方法のヒントを含める

### 3.4 セキュリティ要件

#### REQ-021: ファイルアクセス制限

- **優先度**: 中
- **説明**: 指定されたファイル/ディレクトリのみにアクセスする
- **詳細**:
  - 意図しないファイルへのアクセスを防止
  - シンボリックリンクの処理はOSの標準動作に依存

#### REQ-022: EXIF情報のプライバシー保護

- **優先度**: 中
- **説明**: EXIF情報の削除機能により、プライバシー保護を支援する
- **詳細**:
  - GPS情報などの個人情報を含むEXIF情報を削除可能
  - `--remove-exif`オプションで簡単に削除できる

### 3.5 保守性要件

#### REQ-023: コード品質

- **優先度**: 中
- **説明**: 保守しやすいコードを書く
- **詳細**:
  - Goのコーディング規約に準拠
  - 適切なコメントを記述
  - エラーハンドリングを適切に実装

#### REQ-024: テスト

- **優先度**: 中
- **説明**: 主要な機能についてテストを実装する
- **詳細**:
  - 単体テストの実装
  - 統合テストの実装（可能な範囲で）

## 4. 制約事項

### 4.1 技術的制約

#### CON-001: CGO依存

- **説明**: `goheif`ライブラリがCGOを必要とするため、クロスコンパイルが複雑
- **影響**: macOS向けバイナリはmacOS環境でビルドする必要がある（osxcrossが必要）

#### CON-002: ストリーミング処理未対応

- **説明**: 画像全体をメモリに読み込む必要がある
- **影響**: 非常に大きな画像ファイルの場合はメモリ使用量が増加

#### CON-003: 並列処理未対応

- **説明**: 現時点では順次処理のみ
- **影響**: 大量のファイルを変換する場合、処理時間がかかる

### 4.2 機能制約

#### CON-004: JPEG品質固定

- **説明**: JPEG品質が95で固定されている
- **影響**: ユーザーが品質を調整できない

#### CON-005: 出力先固定

- **説明**: 出力ディレクトリが入力ファイルと同じ（変更不可）
- **影響**: ユーザーが出力先を指定できない

#### CON-006: 出力ファイル名自動生成

- **説明**: 出力ファイル名が自動生成される（カスタマイズ不可）
- **影響**: ユーザーが出力ファイル名を指定できない

## 5. 依存関係

### 5.1 外部ライブラリ

#### DEP-001: goheif

- **説明**: HEIC形式のデコードに使用
- **バージョン**: v0.0.0-20230113233934-ca402e77a786
- **ライセンス**: 要確認

#### DEP-002: go-exif

- **説明**: EXIF情報の処理に使用
- **バージョン**: v3.0.1
- **ライセンス**: 要確認

#### DEP-003: go-jpeg-image-structure

- **説明**: JPEG構造の操作に使用
- **バージョン**: v2.0.0-20221012074422-4f3f7e934102
- **ライセンス**: 要確認

### 5.2 ビルドツール

#### DEP-004: Go

- **説明**: プログラミング言語とビルドツール
- **バージョン**: 1.23以上
- **ライセンス**: BSD-style

#### DEP-005: Make

- **説明**: ビルドプロセスの自動化
- **バージョン**: 任意
- **ライセンス**: GPL

## 6. 優先度マトリクス

### 6.1 機能要件の優先度

| 要件ID | 機能 | 優先度 | 実装状況 |
|--------|------|--------|----------|
| REQ-001 | HEICからJPEGへの変換 | 最高 | ✅ 実装済み |
| REQ-002 | 単一ファイル変換 | 最高 | ✅ 実装済み |
| REQ-003 | ディレクトリ一括変換 | 高 | ✅ 実装済み |
| REQ-004 | カレントディレクトリ処理 | 高 | ✅ 実装済み |
| REQ-005 | EXIF情報の保持 | 高 | ✅ 実装済み |
| REQ-006 | EXIF情報の削除オプション | 中 | ✅ 実装済み |
| REQ-007 | EXIF情報の表示オプション | 中 | ✅ 実装済み |
| REQ-008 | EXIF情報のチェック機能 | 中 | ✅ 実装済み |
| REQ-009 | エラーハンドリング | 高 | ✅ 実装済み |
| REQ-010 | 色空間変換 | 高 | ✅ 実装済み |
| REQ-011 | 品質設定オプション | 低 | ❌ 未実装 |
| REQ-012 | 出力ディレクトリ指定 | 低 | ❌ 未実装 |
| REQ-013 | 元ファイル削除オプション | 低 | ❌ 未実装 |
| REQ-014 | 並列処理 | 低 | ❌ 未実装 |

### 6.2 非機能要件の優先度

| 要件ID | 要件 | 優先度 | 実装状況 |
|--------|------|--------|----------|
| REQ-015 | 処理速度 | 中 | ✅ 実装済み |
| REQ-016 | メモリ使用量 | 中 | ✅ 実装済み |
| REQ-017 | プラットフォーム対応 | 最高 | ✅ 実装済み |
| REQ-018 | Goバージョン | 高 | ✅ 実装済み |
| REQ-019 | コマンドラインインターフェース | 高 | ✅ 実装済み |
| REQ-020 | エラーメッセージ | 高 | ✅ 実装済み |
| REQ-021 | ファイルアクセス制限 | 中 | ✅ 実装済み |
| REQ-022 | EXIF情報のプライバシー保護 | 中 | ✅ 実装済み |
| REQ-023 | コード品質 | 中 | ✅ 実装済み |
| REQ-024 | テスト | 中 | ⚠️ 一部実装 |

## 7. 受け入れ基準

### 7.1 機能要件の受け入れ基準

#### REQ-001の受け入れ基準

- HEICファイルを正常にJPEGファイルに変換できること
- 変換後のJPEGファイルが一般的な画像ビューアーで開けること
- 画像の視覚的な品質が適切に保たれていること

#### REQ-002の受け入れ基準

- 単一のHEICファイルを指定して変換できること
- ファイルが存在しない場合は適切なエラーメッセージを表示すること

#### REQ-003の受け入れ基準

- ディレクトリ内の全HEICファイルを再帰的に検索して変換できること
- 変換結果のサマリーを表示すること

#### REQ-004の受け入れ基準

- 引数なしで実行した場合、カレントディレクトリ内の全HEICファイルを変換できること

#### REQ-005の受け入れ基準

- デフォルトではEXIF情報を保持すること
- EXIF情報が存在しない場合は、EXIFなしでJPEGを生成すること

#### REQ-006の受け入れ基準

- `--remove-exif`オプションでEXIF情報を完全に削除できること
- 変換後のJPEGファイルにEXIF情報が含まれていないこと

#### REQ-007の受け入れ基準

- `--show-exif`オプションでEXIF情報を表示できること
- 主要なEXIFタグが表示されること

#### REQ-008の受け入れ基準

- `--check-exif`オプションでJPEGファイルのEXIF情報をチェックできること
- EXIF情報が残っている場合は警告を表示すること
- チェック結果のサマリーを表示すること

### 7.2 非機能要件の受け入れ基準

#### REQ-017の受け入れ基準

- Windows、macOS、Linuxの各プラットフォームでビルド・実行できること
- 各プラットフォーム向けのバイナリを生成できること

#### REQ-019の受け入れ基準

- 引数なしで実行した場合、使用方法を表示すること
- オプションの説明を表示すること

## 8. 用語集

### 8.1 技術用語

- **HEIC**: High Efficiency Image Container。iOSデバイスで使用される画像形式
- **JPEG**: Joint Photographic Experts Group。広く使用されている画像形式
- **EXIF**: Exchangeable Image File Format。デジタルカメラの画像ファイルに記録されるメタデータ
- **CGO**: C Go。Go言語からC言語のコードを呼び出すための機能
- **RGBA**: Red, Green, Blue, Alpha。色空間の一種
- **NRGBA**: Non-premultiplied RGBA。色空間の一種
- **YCbCr**: 輝度と色差を表現する色空間

### 8.2 プロジェクト用語

- **カレントディレクトリ**: 現在の作業ディレクトリ
- **再帰的検索**: サブディレクトリも含めて検索すること
- **一括変換**: 複数のファイルを一度に変換すること

## 9. 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-12-20 | 1.0 | 初版作成 | - |

---

**ドキュメントバージョン**: 1.0  
**最終更新日**: 2025年12月  
**次回レビュー予定日**: 未定
